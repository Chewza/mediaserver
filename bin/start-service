#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

#/
#/ Usage:
#/              start-service [service]
#/ Description:
#/              start an existing service that was previously stopped;
#/              if service is already started, no action will be taken;
#/ Commands Used:
#/              docker service ls
#/              docker service scale
#/ Examples:
#/              start-service plex
#/              start-service nginx
#/ Flags:
#/              --help: display this help message
#/

abs()     { echo "$(cd "$(dirname "${1}")" && pwd)/$(basename "${1}")"; }
usage()   { grep '^#/' "$0" | cut -c4- ; exit 0 ; }
info()    { echo "[INFO]    $*" ; }
warning() { echo "[WARNING] $*" ; }
error()   { echo "[ERROR]   $*" ; }
fatal()   { echo "[FATAL]   $*" ; exit 1 ; }

expr "$*" : ".*--help" > /dev/null && usage

readonly THIS_FILE="$(basename "$0")"
readonly BIN_DIR="$(dirname "$(abs "${BASH_SOURCE[0]}")")"
readonly PID_FILE="/tmp/${THIS_FILE%.*}.pid"
readonly LOG_FILE="/tmp/${THIS_FILE%.*}.log"
readonly SCRATCH_DIR="$(mktemp -d -t tmp.XXXXXXXXXX)"

cleanup() {
        info "cleaning up ..."
        rm "${PID_FILE}" 2>/dev/null
	rm -rf "${SCRATCH_DIR}" 2>/dev/null
}

# exit here if this script was sourced
[[ "${BASH_SOURCE[0]:-$0}" != "$0" ]] && exit 0

trap cleanup INT TERM EXIT

# redirect output to log
[ -t 1 ] || exec &> >(ts >>"${LOG_FILE}")

# exit if pid exists
[ -f "${PID_FILE}" ] && fatal "$THIS_FILE is already running!"

# start a new pid
echo $$ > "${PID_FILE}"

[ -n "${1:-}" ] || fatal "service name is required"

readonly SERVICE_NAME="mediaserver_${1:-}"

docker service ls | grep -q "${SERVICE_NAME}" || fatal "service ${SERVICE_NAME} does not exist"

info "starting service ${SERVICE_NAME} ..."
docker service scale --detach=true ${SERVICE_NAME}=1
info "... task is running in background"
info "check status with 'docker service ls' and 'docker ps'
